var CANVAS_WIDTH=1600,CANVAS_HEIGHT=1200,CANVAS_X,CANVAS_Y,CANVAS_active=false,CANVAS_panning=false,CANVAS_cursorM=false,CANVAS_xOnPan,CANVAS_yOnPan,MOUSE_xOnPan,MOUSE_yOnPan,MOUSE_curr,MOUSE_hist=new Point(0,0),MOUSE_velocity=new Point(0,0),DRAW_interval=0,DRAW_minDensity=20,DRAW_maxDensity=600,DRAW_skew=false,KEYDN_space=false,KEYDN_shift=false,KEYDN_ctrl=false,UI_active=false,GUI_bottom=265,A_old=0;var sketch=new Drawing();var canvas=document.getElementById("sketch");canvas.width=CANVAS_WIDTH;canvas.height=CANVAS_HEIGHT;canvas.addEventListener("mousedown",onCanvasMousedown,false);var ctx=canvas.getContext("2d");ctx.line=drawLine;ctx.lineWidth=0.5;ctx.fillStyle="rgb(255, 255, 255)";ctx.fillRect(0,0,CANVAS_WIDTH,CANVAS_HEIGHT);skewing=document.getElementById("skewing");skewing.addEventListener("mousedown",onSkewMousedown,false);var currOpacity=document.getElementById("current-opacity"),currDensity=document.getElementById("current-density"),currCache=document.getElementById("current-cache");currCache.innerHTML="0";var uiDensity=document.getElementById("sketch-density"),uiOpacity=document.getElementById("sketch-opacity");var ui_initialA=3*Math.PI/4;uiOpacity.opacity=map(ui_initialA,0,Math.PI,1,0);uiDensity.bottomPos=GUI_bottom;uiDensity.leftPos=20;uiDensity.radius=60;uiDensity.density=map(60,15,80,DRAW_minDensity,DRAW_maxDensity);uiDensity.render=drawCircle;uiDensity.render();var uix=uiDensity.leftPos,uiy=uiDensity.bottomPos;uiOpacity.xpos=uix+60*Math.sin(ui_initialA);uiOpacity.ypos=uiy+60*Math.cos(ui_initialA);uiOpacity.render=drawSwivel;uiOpacity.render();uiOpacity.addEventListener("mousedown",onUiOpacityMousedown,false);document.addEventListener("mouseup",onDocumentMouseup,false);document.addEventListener("mousemove",onDocumentMousemove,false);document.addEventListener("keydown",onDocumentKeydown,false);document.addEventListener("keyup",onDocumentKeyup,false);function onCanvasMousedown(a){a.preventDefault();if(KEYDN_space){CANVAS_panning=false;MOUSE_xOnPan=a.clientX;MOUSE_yOnPan=a.clientY;CANVAS_xOnPan=canvas.offsetLeft;CANVAS_yOnPan=canvas.offsetTop;return}renderPoint(a,0);CANVAS_active=true}function onUiOpacityMousedown(a){a.preventDefault();UI_active=true}function onSkewMousedown(a){if(DRAW_skew){this.innerHTML="velocity skewing disabled";this.className="disabled";this.href="#/  X(";DRAW_skew=false}else{this.innerHTML="velocity skewing enabled";this.className="enabled";this.href="#/  <|:{";DRAW_skew=true}}function onDocumentMouseup(a){CANVAS_panning=false;CANVAS_active=false;UI_active=false}function onDocumentMousemove(g){if(CANVAS_panning){canvas.style.left=(g.clientX-MOUSE_xOnPan+CANVAS_xOnPan)+"px";canvas.style.top=(g.clientY-MOUSE_yOnPan+CANVAS_yOnPan)+"px"}if(KEYDN_space&&CANVAS_panning&&!CANVAS_cursorM){canvas.style.cursor="move";CANVAS_cursorM=true}else{if(!CANVAS_panning&&CANVAS_cursorM){canvas.style.cursor="crosshair";CANVAS_cursorM=false}}if(CANVAS_active){if(DRAW_interval<=0){renderPoint(g,1);DRAW_interval=3}DRAW_interval--}if(UI_active){var f=g.clientX,c=g.clientY,d=uiDensity.leftPos,b=window.innerHeight-uiDensity.bottomPos,h=Math.atan2(c-b,f-d)+Math.PI/2,a=linear_distance(f,c,d,b);if(a>15&&a<80){uiDensity.radius=a;uiDensity.density=map(a,15,80,DRAW_minDensity,DRAW_maxDensity)}if(a<15){a=15}if(a>80){a=80}if(h>0&&h<Math.PI&&!KEYDN_shift){uiOpacity.xpos=d+a*Math.sin(h);uiOpacity.ypos=uiDensity.bottomPos+a*Math.cos(h);uiOpacity.opacity=map(h,0,Math.PI,1,0);A_old=h}else{uiOpacity.xpos=d+a*Math.sin(A_old);uiOpacity.ypos=uiDensity.bottomPos+a*Math.cos(A_old)}uiDensity.render();uiOpacity.render()}}function renderPoint(b,a){CANVAS_X=b.clientX-canvas.offsetLeft-200;CANVAS_Y=b.clientY-canvas.offsetTop;np=new Point(CANVAS_X,CANVAS_Y,uiDensity.density);MOUSE_curr=np;if(a){setVelocity(b)}else{MOUSE_velocity.mult(0)}sketch.addPoint(np);currCache.innerHTML=sketch.pointCache.length;sketch.render();MOUSE_hist=MOUSE_curr}function setVelocity(a){MOUSE_velocity=Point.prototype.subt(MOUSE_curr,MOUSE_hist)}function onDocumentKeydown(a){switch(a.keyCode){case 32:KEYDN_space=true;break;case 16:KEYDN_shift=true;break;case 17:KEYDN_ctrl=true;break;case 83:if(KEYDN_ctrl&&KEYDN_shift){saveDrawing()}break;case 8:case 46:if(KEYDN_ctrl){sketch.dumpCache();sketch.drawnP=0;currCache.innerHTML=sketch.pointCache.length}break}}function onDocumentKeyup(a){switch(a.keyCode){case 32:KEYDN_space=false;break;case 16:KEYDN_shift=false;break;case 17:KEYDN_ctrl=false;break}}function Drawing(){this.pointCache=new Array();this.drawnP=0;this.addPoint=function(a){this.pointCache.push(a);this.drawnP++};this.render=function(){dp=this.drawnP;pc=this.pointCache;if(dp>0){p=pc[dp-1];p.connect(pc)}};this.dumpCache=function(){this.pointCache.length=0}}function Point(b,a,c){this.x=b;this.y=a;this.maxDist=c}Point.prototype.connect=function(c){var e=c.length;if(e>1){for(i=0;i<e;i++){p=c[i];p_dist=linear_distance(p.x,p.y,this.x,this.y);p.tempDist=p_dist}c.sort(comparePointDists);var d=0,a=this.maxDist;for(i=0;i<e;i++){p=c[i];var b=p.tempDist;d+=b;if(d<a*5&&b<a){ctx.strokeStyle="rgba( 0,0,0,"+uiOpacity.opacity+" )";ctx.line(this.x,this.y,p.x,p.y)}else{break}}}};function comparePointDists(d,c){return d.tempDist-c.tempDist}Point.prototype.subt=function(b,a){if(a){v3=new Point(b.x-a.x,b.y-a.y);return v3}else{this.x=this.x-b.x;this.y=this.y-b.y}};Point.prototype.mult=function(a){this.x=this.x*a;this.y=this.y*a};function drawLine(b,d,a,c){this.beginPath();this.moveTo(b,d);if(DRAW_skew){cp1x=b+MOUSE_velocity.x;cp1y=d+MOUSE_velocity.y;cp2x=a+MOUSE_velocity.x;cp2y=c+MOUSE_velocity.y;this.bezierCurveTo(cp1x,cp1y,cp2x,cp2y,a,c)}else{this.lineTo(a,c)}this.stroke()}function drawCircle(){var a=this.radius;this.style.bottom=this.bottomPos-a+"px";this.style.left=-a+this.leftPos+"px";this.style.width=2*a+"px";this.style.height=2*a+"px";this.style.borderRadius=a+"px";this.style.MozBorderRadius=a+"px";this.style.WebkitBorderRadius=a+"px";this.style.background="rgba( 0,0,0,"+uiOpacity.opacity+" )";currDensity.innerHTML=Math.round(uiDensity.density)}function drawSwivel(){var a=this.xpos,b=this.ypos;this.style.left=a-12+"px";this.style.bottom=b-12+"px";currOpacity.innerHTML=Math.round(uiOpacity.opacity*100)}function saveDrawing(){window.open(canvas.toDataURL("image/png"),"mywindow")}function linear_distance(a,c,b,d){return Math.abs(Math.sqrt(Math.pow(a-b,2)+Math.pow(c-d,2)))}function map(d,b,c,a,e){return a+(e-a)*((d-b)/(c-b))};